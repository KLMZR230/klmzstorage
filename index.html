<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KLMZ STORAGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Deshabilitar selección y toques complejos */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            -webkit-tap-highlight-color: transparent;
            /* Evita el zoom de doble toque en navegadores modernos */
            touch-action: manipulation; 
            /* Evita la selección de texto e imágenes (Protección básica) */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Evita arrastrar imágenes */
            -webkit-user-drag: none;
        }
        
        /* Drag & Drop */
        #drop-area { transition: all 0.3s ease; }
        #drop-area.drag-active { border-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); }
        .action-btn { @apply p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700 transition-colors duration-200; }
        #image-modal-backdrop, #edit-modal-backdrop, #delete-modal-backdrop { background-color: rgba(0, 0, 0, 0.96); backdrop-filter: blur(5px); }
        #progress-fill { transition: width 0.1s linear; }
        
        /* Deshabilitar clic derecho en imágenes para evitar "Guardar como" */
        img { pointer-events: none; }
    </style>
</head>
<body class="min-h-screen text-gray-100 pb-10" oncontextmenu="return false;">

    <div class="container mx-auto px-4 py-6 max-w-6xl">

        <header class="mb-6 flex justify-between items-center border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-widest pointer-events-none">KLMZ STORAGE</h1>
                <p id="auth-status" class="text-xs text-gray-500 font-medium mt-1">Cargando...</p>
            </div>
            <button id="logout-button" onclick="handleSignOut()" class="px-3 py-1.5 bg-gray-800 border border-gray-700 text-gray-300 text-xs font-bold rounded-full hover:bg-gray-700 transition hidden">Salir</button>
        </header>
        
        <div id="auth-controls" class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl border border-gray-700 shadow-xl max-w-sm mx-auto mt-10 hidden">
            <h2 class="text-lg font-bold text-white mb-4 text-center">Acceso Seguro</h2>
            <input type="email" id="email-input" placeholder="Correo" class="w-full p-3 mb-3 bg-gray-900/80 text-white rounded-xl border border-gray-700 focus:border-indigo-500 outline-none text-sm select-text" style="user-select: text;">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 mb-4 bg-gray-900/80 text-white rounded-xl border border-gray-700 focus:border-indigo-500 outline-none text-sm select-text" style="user-select: text;">
            <div class="flex gap-2 mb-4">
                <button onclick="handleEmailSignIn()" class="flex-1 py-2.5 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700 transition">Entrar</button>
                <button onclick="handleEmailSignUp()" class="flex-1 py-2.5 bg-gray-700 text-white text-sm font-bold rounded-xl hover:bg-gray-600 transition">Registro</button>
            </div>
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-700"></div><span class="flex-shrink-0 mx-4 text-gray-500 text-xs">O continúa con</span><div class="flex-grow border-t border-gray-700"></div>
            </div>
            <button onclick="handleGoogleSignIn()" class="w-full py-2.5 bg-white text-gray-900 font-bold rounded-xl shadow hover:bg-gray-100 transition flex items-center justify-center gap-2 mt-2">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/><path fill="#FF3D00" d="M24 44c6.333 0 11.667-2.083 15.55-5.633l-4.317-3.35c-2.375 1.583-5.3 2.516-8.233 2.516-6.425 0-11.883-4.317-13.842-10.15H5.85l-.167 3.433c3.784 7.467 11.4 12.75 18.317 12.75z"/><path fill="#4CAF50" d="M24 10.183c3.55 0 6.675 1.25 9.158 3.517l4.517-4.5c-4.1-3.783-9.583-6.133-13.675-6.133-6.917 0-14.534 5.283-18.317 12.75l4.192 3.267c1.958-5.834 7.416-10.15 13.842-10.15z"/><path fill="#1976D2" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/></svg> Google
            </button>
        </div>

        <div id="upload-section" class="mb-8 hidden"> 
            <div id="drop-area" class="relative p-6 rounded-2xl border-2 border-gray-700 border-dashed bg-gray-800/30 hover:bg-gray-800/50 transition-all text-center">
                <input type="file" id="fileInput" class="hidden" accept="image/*,video/*" onchange="handleFiles(this.files)" multiple />
                
                <div id="upload-prompt" class="flex flex-col items-center">
                    <div class="p-3 bg-gray-800 rounded-full mb-3 shadow-lg pointer-events-none">
                        <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m0 0l3-3m-3 3l3 3" /></svg>
                    </div>
                    <button onclick="document.getElementById('fileInput').click()" id="upload-button" class="px-5 py-2 bg-indigo-600 text-white text-sm font-bold rounded-xl shadow-lg hover:bg-indigo-500 transition active:scale-95">
                        Subir Archivos (Máx 2.5GB)
                    </button>
                </div>

                <div id="upload-indicator" class="hidden flex flex-col items-center w-full max-w-md mx-auto">
                    <div class="flex justify-between w-full text-xs text-gray-400 mb-1 px-1">
                        <span id="progress-text">Subiendo...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden shadow-inner">
                        <div id="progress-fill" class="bg-gradient-to-r from-indigo-500 to-cyan-400 h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-detail" class="text-[10px] text-gray-500 mt-2">Preparando...</p>
                </div>
            </div>
            <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-full shadow-2xl text-xs font-bold hidden transition-all text-center w-max max-w-[90%]"></div>
        </div>

        <section id="file-list-section" class="hidden">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-lg font-bold text-gray-200">Galería</h2>
                <span id="file-count" class="text-xs text-gray-500">0 archivos</span>
            </div>
            <div id="file-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                <p id="empty-state" class="col-span-full text-gray-500 text-center py-10 text-sm">No hay archivos aún.</p>
            </div>
        </section>
    </div>
    
    <div id="edit-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-200" onclick="hideEditModal()">
        <div class="bg-gray-800 p-5 rounded-2xl shadow-2xl w-11/12 max-w-xs transform scale-95 transition-transform duration-200" id="edit-modal-content" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-white mb-4">Renombrar</h3>
            <input type="text" id="new-file-name-input" class="w-full p-3 bg-gray-900 text-white rounded-xl border border-gray-700 focus:border-indigo-500 outline-none mb-4 text-sm select-text" style="user-select: text;">
            <div class="flex gap-2">
                <button onclick="hideEditModal()" class="flex-1 py-2 text-gray-400 font-semibold hover:text-white">Cancelar</button>
                <button onclick="saveNewFileName()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-500">Guardar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-200" onclick="hideDeleteModal()">
        <div class="bg-gray-800 p-5 rounded-2xl shadow-2xl w-11/12 max-w-xs text-center transform scale-95 transition-transform duration-200" id="delete-modal-content" onclick="event.stopPropagation()">
            <div class="mx-auto w-12 h-12 bg-red-900/30 rounded-full flex items-center justify-center mb-3">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">¿Eliminar?</h3>
            <p class="text-xs text-gray-400 mb-6">Esta acción borrará "<span id="delete-file-name" class="text-white"></span>".</p>
            <div class="flex gap-2">
                <button onclick="hideDeleteModal()" class="flex-1 py-2 bg-gray-700 text-white rounded-lg font-semibold">No</button>
                <button onclick="confirmDeleteFile()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold shadow">Sí, borrar</button>
            </div>
        </div>
    </div>

    <div id="image-modal-backdrop" class="fixed inset-0 z-50 bg-black flex items-center justify-center hidden transition-opacity duration-300" onclick="hideImageModal()" oncontextmenu="return false;">
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white/80 hover:text-white z-50 p-2 bg-gray-800/50 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        <img id="modal-image" src="" alt="Full" class="max-h-screen max-w-full object-contain transition-transform duration-300 transform scale-95 select-none" style="pointer-events: auto;"> 
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyClcgVHympGTuj7h4hgqxXfVcpqwWaKsyg",
            authDomain: "klmzstorage.firebaseapp.com",
            projectId: "klmzstorage", 
            storageBucket: "klmzstorage.firebasestorage.app",
            appId: "1:685345835162:web:be21ed8302df42360f3723"
        };
        const R2_BUCKET_NAME = 'klmzstorage';
        const WORKER_ENDPOINT = 'https://klmz-r2-signer-cli-production.klmzr.workers.dev/get-signed-url'; 
        const R2_PUBLIC_URL_BASE = 'https://pub-897465909ad64d05890fbf61be36d501.r2.dev'; 
        const MAX_FILE_SIZE = 2.5 * 1024 * 1024 * 1024; // 2.5 GB

        let app, db, auth, userId = null, isUploading = false, authReady = false;
        
        // DOM
        const els = {
            authStatus: document.getElementById('auth-status'),
            fileList: document.getElementById('file-list'),
            messageBox: document.getElementById('message-box'),
            uploadIndicator: document.getElementById('upload-indicator'),
            uploadPrompt: document.getElementById('upload-prompt'),
            uploadButton: document.getElementById('upload-button'),
            fileInput: document.getElementById('fileInput'),
            authControls: document.getElementById('auth-controls'),
            uploadSection: document.getElementById('upload-section'),
            fileListSection: document.getElementById('file-list-section'),
            logoutButton: document.getElementById('logout-button'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            emptyState: document.getElementById('empty-state'),
            modalBackdrop: document.getElementById('image-modal-backdrop'),
            modalImage: document.getElementById('modal-image'),
            editModalBackdrop: document.getElementById('edit-modal-backdrop'),
            editModalContent: document.getElementById('edit-modal-content'),
            newFileNameInput: document.getElementById('new-file-name-input'),
            deleteModalBackdrop: document.getElementById('delete-modal-backdrop'),
            deleteModalContent: document.getElementById('delete-modal-content'),
            deleteFileName: document.getElementById('delete-file-name'),
            fileCount: document.getElementById('file-count'),
            progressFill: document.getElementById('progress-fill'),
            progressPercent: document.getElementById('progress-percent'),
            progressText: document.getElementById('progress-text'),
            progressDetail: document.getElementById('progress-detail')
        };

        let editState = { fileId: null, currentName: null };
        let deleteState = { fileId: null };

        // PREVENIR ZOOM DOBLE TAP (JS)
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });

        // --- Helpers ---
        window.showMessage = (msg, type = 'info') => {
            if (!msg) { els.messageBox.classList.add('hidden'); return; }
            els.messageBox.textContent = msg;
            const colors = type === 'error' ? 'bg-red-600 text-white' : (type === 'success' ? 'bg-green-600 text-white' : 'bg-indigo-600 text-white');
            els.messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-5 py-2.5 rounded-full shadow-2xl text-xs font-bold transition-all duration-300 ${colors}`;
            els.messageBox.classList.remove('hidden');
            if (type !== 'error') setTimeout(() => els.messageBox.classList.add('hidden'), 3000);
        };

        const formatSize = (b) => b === 0 ? '0 B' : `${parseFloat((b / Math.pow(1024, Math.floor(Math.log(b) / Math.log(1024)))).toFixed(1))} ${['B', 'KB', 'MB', 'GB', 'TB'][Math.floor(Math.log(b) / Math.log(1024))]}`;

        function updateProgressBar(percent, text = 'Subiendo...') {
            els.progressFill.style.width = `${percent}%`;
            els.progressPercent.textContent = `${Math.round(percent)}%`;
            els.progressText.textContent = text;
        }

        function uploadFileXHR(url, file, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', url, true);
                xhr.setRequestHeader('Content-Type', file.type);
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        onProgress(percentComplete);
                    }
                };
                xhr.onload = () => { if (xhr.status >= 200 && xhr.status < 300) resolve(xhr.response); else reject(new Error(`Upload failed: ${xhr.statusText}`)); };
                xhr.onerror = () => reject(new Error("Network error"));
                xhr.send(file);
            });
        }

        // --- Renderizado ---
        function renderFileItem(file) {
            const date = file.uploadedAt?.toDate ? file.uploadedAt.toDate().toLocaleDateString() : '...';
            const url = `${R2_PUBLIC_URL_BASE}/${file.r2Key}`;
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            let previewContent = '';
            if (isImage) {
                previewContent = `<img src="${url}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" loading="lazy" style="pointer-events: none;">`;
            } else if (isVideo) {
                previewContent = `<div class="flex items-center justify-center h-full text-indigo-400 bg-gray-900"><svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.7V15.3a1 1 0 01-1.447.886L15 14M4 14V9a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2z"></path></svg></div>`;
            } else {
                previewContent = `<div class="flex items-center justify-center h-full text-gray-500 bg-gray-900"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>`;
            }

            const clickAction = isImage ? `onclick="showImageModal('${url}')"` : (isVideo ? `onclick="downloadFile('${file.r2Key}', '${file.name}')"` : '');

            return `
                <div class="group relative bg-gray-800 rounded-2xl overflow-hidden border border-gray-700/50 shadow-lg hover:shadow-indigo-500/10 transition-all duration-300">
                    <div class="aspect-square w-full bg-gray-900 cursor-pointer overflow-hidden relative" ${clickAction}>
                        ${previewContent}
                        <span class="absolute bottom-2 right-2 text-[10px] bg-black/60 backdrop-blur-sm px-1.5 rounded text-white uppercase font-bold tracking-wide border border-white/10">${file.name.split('.').pop()}</span>
                    </div>
                    <div class="p-3">
                        <p class="text-sm font-bold text-gray-200 truncate mb-0.5">${file.name}</p>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] text-gray-500">${formatSize(file.size)}</span>
                            <span class="text-[10px] text-gray-600">${date}</span>
                        </div>
                        <div class="flex justify-between items-center border-t border-gray-700/50 pt-2">
                            <button onclick="downloadFile('${file.r2Key}', '${file.name}')" class="action-btn text-indigo-400 hover:bg-indigo-500/20"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                            <button onclick="showEditModal('${file.id}', '${file.name}')" class="action-btn text-teal-400 hover:bg-teal-500/20"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="showDeleteModal('${file.id}', '${file.name}')" class="action-btn text-red-400 hover:bg-red-500/20"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Modales ---
        const toggleModal = (backdrop, content, show) => {
            if (show) {
                backdrop.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    if(content) content.classList.remove('scale-95');
                }, 10);
            } else {
                backdrop.classList.add('opacity-0');
                if(content) content.classList.add('scale-95');
                setTimeout(() => backdrop.classList.add('hidden'), 200);
            }
        };

        window.showImageModal = (url) => { els.modalImage.src = url; toggleModal(els.modalBackdrop, els.modalImage, true); };
        window.hideImageModal = () => { toggleModal(els.modalBackdrop, els.modalImage, false); setTimeout(() => els.modalImage.src = '', 200); };
        window.showEditModal = (id, name) => { editState = { fileId: id, currentName: name }; els.newFileNameInput.value = name; toggleModal(els.editModalBackdrop, els.editModalContent, true); setTimeout(() => els.newFileNameInput.focus(), 100); };
        window.hideEditModal = () => toggleModal(els.editModalBackdrop, els.editModalContent, false);
        window.showDeleteModal = (id, name) => { deleteState = { fileId: id }; els.deleteFileName.textContent = name; toggleModal(els.deleteModalBackdrop, els.deleteModalContent, true); };
        window.hideDeleteModal = () => toggleModal(els.deleteModalBackdrop, els.deleteModalContent, false);

        // --- Acciones ---
        window.saveNewFileName = async () => {
            const newName = els.newFileNameInput.value.trim();
            if (!newName || newName === editState.currentName) return window.hideEditModal();
            window.hideEditModal();
            window.showMessage("Actualizando...", 'info');
            try { await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'klmz_storage_files', editState.fileId), { name: newName }); window.showMessage("Renombrado.", 'success'); } catch (e) { window.showMessage(e.message, 'error'); }
        };

        window.confirmDeleteFile = async () => {
            window.hideDeleteModal();
            window.showMessage("Eliminando...", 'info');
            try { await deleteDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'klmz_storage_files', deleteState.fileId)); window.showMessage("Eliminado.", 'success'); } catch (e) { window.showMessage(e.message, 'error'); }
        };

        window.downloadFile = async (r2Key, fileName) => {
            const cacheBuster = "?t=" + new Date().getTime();
            window.showMessage("Descargando...", 'info');
            try {
                const res = await fetch(`${R2_PUBLIC_URL_BASE}/${r2Key}${cacheBuster}`);
                if (!res.ok) throw new Error();
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                window.showMessage("Listo.", 'success');
            } catch (e) { window.open(`${R2_PUBLIC_URL_BASE}/${r2Key}`, '_blank'); }
        };

        // --- Core Upload ---
        async function processQueue(files) {
            if (isUploading) return;
            isUploading = true;
            els.uploadPrompt.classList.add('hidden');
            els.uploadIndicator.classList.remove('hidden');
            els.uploadButton.disabled = true;

            let count = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > MAX_FILE_SIZE) { window.showMessage(`${file.name} > 2.5GB`, 'error'); continue; }
                
                els.progressDetail.textContent = `Archivo ${i + 1} de ${files.length}: ${file.name}`;
                updateProgressBar(0, `Iniciando...`);

                try {
                    const key = `${userId}/${crypto.randomUUID()}.${file.name.split('.').pop()}`;
                    const signRes = await fetch(`${WORKER_ENDPOINT}?key=${key}&contentType=${file.type}`);
                    if (!signRes.ok) throw new Error();
                    const { signedUrl } = await signRes.json();

                    await uploadFileXHR(signedUrl, file, (percent) => updateProgressBar(percent, `Subiendo ${Math.round(percent)}%`));

                    updateProgressBar(100, "Guardando...");
                    await addDoc(collection(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId), 'klmz_storage_files'), {
                        name: file.name, type: file.type, size: file.size, r2Key: key, r2Bucket: R2_BUCKET_NAME, uploaderId: userId, uploadedAt: serverTimestamp()
                    });
                    count++;
                } catch (e) { console.error(e); window.showMessage(`Error en ${file.name}`, 'error'); }
            }
            window.showMessage(count > 0 ? `¡${count} archivos subidos!` : "Error", count > 0 ? 'success' : 'error');
            isUploading = false;
            els.uploadIndicator.classList.add('hidden');
            els.uploadPrompt.classList.remove('hidden');
            els.uploadButton.disabled = false;
            els.fileInput.value = '';
            updateProgressBar(0, "");
        }
        window.handleFiles = (l) => { if(authReady && userId && l?.length) processQueue(Array.from(l)); };

        // --- UI & Auth ---
        function updateUI(user) {
            if (user) {
                userId = user.uid;
                els.authStatus.textContent = "";
                els.authControls.classList.add('hidden');
                els.uploadSection.classList.remove('hidden');
                els.fileListSection.classList.remove('hidden');
                els.logoutButton.classList.remove('hidden');
                
                const q = query(collection(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId), 'klmz_storage_files'), orderBy('uploadedAt', 'desc'));
                onSnapshot(q, (s) => {
                    const files = s.docs.map(d => ({id: d.id, ...d.data()}));
                    els.fileList.innerHTML = files.map(renderFileItem).join('');
                    els.fileCount.textContent = `${files.length} archivo${files.length!==1?'s':''}`;
                    els.emptyState.classList.toggle('hidden', files.length > 0);
                });
            } else {
                userId = null;
                els.authStatus.textContent = "";
                els.authControls.classList.remove('hidden');
                els.uploadSection.classList.add('hidden');
                els.fileListSection.classList.add('hidden');
                els.logoutButton.classList.add('hidden');
            }
        }

        window.handleGoogleSignIn = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { window.showMessage(e.message, 'error'); } };
        window.handleEmailSignIn = async () => { try { await signInWithEmailAndPassword(auth, els.emailInput.value, els.passwordInput.value); } catch(e) { window.showMessage(e.message, 'error'); } };
        window.handleEmailSignUp = async () => { try { await createUserWithEmailAndPassword(auth, els.emailInput.value, els.passwordInput.value); } catch(e) { window.showMessage(e.message, 'error'); } };
        window.handleSignOut = () => signOut(auth);

        window.onload = () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, (u) => { authReady = true; updateUI(u); setupDragAndDrop(); });
        };

        function setupDragAndDrop() {
            const dropArea = document.getElementById('drop-area');
            if(!dropArea) return;
            ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, (ev) => { ev.preventDefault(); dropArea.classList.add('drag-active'); }));
            ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, (ev) => { ev.preventDefault(); dropArea.classList.remove('drag-active'); }));
            dropArea.addEventListener('drop', (e) => window.handleFiles(e.dataTransfer.files));
        }
    </script>
</body>
</html>
