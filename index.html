<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLMZ Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        #drop-area.drag-active {
            border-color: #4f46e5;
            background-color: #1f2937;
        }
        /* Estilo para que la miniatura cubra el contenedor */
        .thumbnail-container {
            width: 50px;
            height: 50px;
            overflow: hidden;
            border-radius: 6px;
            cursor: pointer; /* Indicador de clic */
            transition: transform 0.2s;
        }
        .thumbnail-container:hover {
            transform: scale(1.05); /* Efecto hover en la miniatura */
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Estilos mejorados para los botones de acción */
        .action-button {
            @apply p-1 rounded-full text-gray-400 hover:text-white transition duration-150;
            @apply shadow-md; /* Añadimos sombra para profesionalismo */
        }
        .action-button.download {
            @apply hover:bg-indigo-600 hover:text-white;
        }
        .action-button.edit {
            @apply hover:bg-teal-600 hover:text-white;
        }
        .action-button.delete {
            @apply hover:bg-red-600 hover:text-white;
        }
        /* Modal Backdrop */
        #image-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.95);
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 sm:p-8">

        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-teal-400">
                    KLMZ Storage
                </h1>
                <p id="auth-status" class="text-gray-400 mt-1">Esperando autenticación...</p>
            </div>
            <button id="logout-button" onclick="handleSignOut()" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition duration-150 hidden">
                Cerrar Sesión
            </button>
        </header>
        
        <div id="auth-controls" class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-md mx-auto mb-8 hidden">
            <h2 class="text-xl font-semibold text-white mb-4">Iniciar Sesión / Registrarse</h2>
            
            <input type="email" id="email-input" placeholder="Correo Electrónico" class="w-full p-3 mb-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">

            <div class="flex space-x-3 mb-4">
                <button onclick="handleEmailSignIn()" class="flex-1 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    Iniciar Sesión
                </button>
                <button onclick="handleEmailSignUp()" class="flex-1 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150">
                    Registrarse
                </button>
            </div>

            <div class="text-center my-4 text-gray-400">o continuar con</div>

            <button onclick="handleGoogleSignIn()" class="w-full py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/><path fill="#FF3D00" d="M24 44c6.333 0 11.667-2.083 15.55-5.633l-4.317-3.35c-2.375 1.583-5.3 2.516-8.233 2.516-6.425 0-11.883-4.317-13.842-10.15H5.85l-.167 3.433c3.784 7.467 11.4 12.75 18.317 12.75z"/><path fill="#4CAF50" d="M24 10.183c3.55 0 6.675 1.25 9.158 3.517l4.517-4.5c-4.1-3.783-9.583-6.133-13.675-6.133-6.917 0-14.534 5.283-18.317 12.75l4.192 3.267c1.958-5.834 7.416-10.15 13.842-10.15z"/><path fill="#1976D2" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/></svg>
                Google
            </button>
        </div>
        <div id="upload-section" class="mb-8 hidden"> 
            <div id="drop-area" class="relative p-8 rounded-xl border-4 border-gray-600 border-dashed bg-gray-800/50 transition-all duration-300">
                <input
                    type="file"
                    id="fileInput"
                    class="hidden"
                    accept="image/*,video/*"
                    onchange="handleFiles(this.files)"
                    multiple 
                />
                <div class="flex flex-col items-center justify-center text-center">
                    <div id="upload-indicator" class="hidden flex items-center space-x-2 text-indigo-400">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-lg font-medium">Subiendo...</span>
                    </div>

                    <div id="upload-prompt" class="block">
                        <svg class="w-12 h-12 text-indigo-400 mb-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m0 0l3-3m-3 3l3 3" />
                        </svg>
                        <p class="text-gray-300 mb-4">Arrastra y suelta tu video o foto aquí, o haz clic.</p>
                        <button
                            onclick="document.getElementById('fileInput').click()"
                            id="upload-button"
                            class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50"
                            disabled
                        >
                            Seleccionar Archivos
                        </button>
                    </div>
                </div>
            </div>

            <div id="message-box" class="mt-4 p-3 rounded-lg text-center text-sm font-medium bg-transparent text-white hidden"></div>
        </div>

        <section id="file-list-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-200 mb-4">Mis Archivos</h2>
            <div id="file-list" class="space-y-3">
                <p id="empty-state" class="text-gray-500 text-center py-10">
                    Sube tu primer archivo para verlo aquí.
                </p>
                </div>
        </section>

    </div>
    
    <div id="image-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center hidden" onclick="hideImageModal()">
        <div class="relative max-w-5xl max-h-screen p-4" onclick="event.stopPropagation()">
            <button onclick="hideImageModal()" class="absolute top-0 right-0 m-4 text-white text-3xl font-bold p-2 bg-black/50 rounded-full hover:bg-black/70">
                &times;
            </button>
            <img id="modal-image" src="" alt="Imagen ampliada" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl">
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables Globales
        let app;
        let db;
        let auth;
        let userId = null;
        let isUploading = false;
        let authReady = false; 

        // ----------------------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE (Credenciales verificadas)
        const firebaseConfig = {
            apiKey: "AIzaSyClcgVHympGTuj7h4hgqxXfVcpqwWaKsyg",
            authDomain: "klmzstorage.firebaseapp.com",
            projectId: "klmzstorage", 
            storageBucket: "klmzstorage.firebasestorage.app",
            appId: "1:685345835162:web:be21ed8302df42360f3723"
        };
        // ----------------------------------------------------------------------------------

        // --- CONFIGURACIÓN DE R2 ---
        const R2_BUCKET_NAME = 'klmzstorage';
        const WORKER_ENDPOINT = 'https://klmz-r2-signer-cli-production.klmzr.workers.dev/get-signed-url'; 
        const R2_PUBLIC_URL_BASE = 'https://pub-897465909ad64d05890fbf61be36d501.r2.dev'; 

        const appId = firebaseConfig.projectId;
        const MAX_FILE_SIZE_BYTES = 100 * 1024 * 1024; // Límite de 100MB

        // Elementos del DOM (cacheado para evitar el error 'null')
        const authStatus = document.getElementById('auth-status');
        const fileList = document.getElementById('file-list');
        const messageBox = document.getElementById('message-box');
        const uploadIndicator = document.getElementById('upload-indicator');
        const uploadPrompt = document.getElementById('upload-prompt');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('fileInput');
        const authControls = document.getElementById('auth-controls');
        const uploadSection = document.getElementById('upload-section');
        const fileListSection = document.getElementById('file-list-section');
        const logoutButton = document.getElementById('logout-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emptyState = document.getElementById('empty-state');
        const modalBackdrop = document.getElementById('image-modal-backdrop');
        const modalImage = document.getElementById('modal-image');


        // --- Utilidades y Funciones de Visualización ---
        function showMessage(msg, type = 'info') {
            if (!msg) {
                messageBox.classList.add('hidden');
                return;
            }
            messageBox.textContent = msg;
            messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium transition-colors';

            if (type === 'error') {
                messageBox.classList.add('bg-red-900/50', 'text-red-300');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-900/50', 'text-green-300');
            } else {
                messageBox.classList.add('bg-indigo-900/50', 'text-indigo-300');
            }
            messageBox.classList.remove('hidden');

            if (type !== 'error') {
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileDisplay(type, publicUrl) {
            if (type.startsWith('image/')) {
                // Modificado para llamar a showImageModal en el onclick
                return `<div class="thumbnail-container bg-gray-600" onclick="showImageModal('${publicUrl}')">
                            <img src="${publicUrl}" alt="Miniatura" loading="lazy">
                        </div>`;
            } else {
                return `<div class="p-1 rounded bg-gray-600/50">${type.startsWith('video/') ? 
                    `<svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.7V15.3a1 1 0 01-1.447.886L15 14M4 14V9a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2z" /></svg>` : 
                    `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`}</div>`;
            }
        }

        function renderFileItem(file) {
            const date = new Date(file.uploadedAt);
            const publicUrl = `${R2_PUBLIC_URL_BASE}/${file.r2Key}`; 
            const displayIcon = getFileDisplay(file.type, publicUrl);

            return `
                <div class="flex items-center justify-between p-4 bg-gray-800 rounded-xl shadow-md transition-colors duration-200 hover:bg-gray-700">
                    <div class="flex items-center space-x-4 min-w-0">
                        ${displayIcon}
                        <div class="min-w-0">
                            <p class="text-sm font-semibold truncate text-white">${file.name}</p>
                            <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <div class="text-right ml-4 flex-shrink-0 flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-3">
                        
                        <p class="text-xs text-gray-500 hidden sm:block">${date.toLocaleString()}</p>

                        <button onclick="downloadFile('${file.r2Key}')" class="action-button download">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </button>
                        
                        <button onclick="editFileName('${file.id}', '${file.name}')" class="action-button edit">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4l-4 4"></path></svg>
                        </button>
                        
                        <button onclick="deleteFile('${file.id}', '${file.name}', '${file.r2Key}')" class="action-button delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- FUNCIONES MODAL (NUEVAS) ---
        window.showImageModal = function(imageUrl) {
            modalImage.src = imageUrl;
            modalBackdrop.classList.remove('hidden');
        }

        window.hideImageModal = function() {
            modalBackdrop.classList.add('hidden');
            modalImage.src = ''; 
        }

        // --- Funciones CRUD y Subida (Se mantienen) ---
        function getFileDocRef(fileId) {
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
            return doc(filesCollectionRef, fileId);
        }

        window.deleteFile = async function(fileId, fileName, r2Key) {
            if (!confirm(`¿Estás seguro de que quieres eliminar "${fileName}"? NOTA: El archivo permanecerá en R2 hasta que se borre manualmente, pero se eliminará de esta lista.`)) {
                return;
            }
            
            showMessage(`Eliminando "${fileName}" de la base de datos...`, 'info');

            try {
                const docRef = getFileDocRef(fileId);
                await deleteDoc(docRef);

                showMessage(`"${fileName}" eliminado con éxito.`, 'success');

            } catch (error) {
                console.error("Error al eliminar el archivo:", error);
                showMessage(`Error al eliminar: ${error.message}. (Verifique las Reglas de Seguridad).`, 'error');
            }
        }

        window.editFileName = async function(fileId, currentName) {
            const newName = prompt(`Introduce el nuevo nombre para "${currentName}":`, currentName);
            if (!newName || newName.trim() === currentName) {
                return;
            }

            showMessage(`Actualizando nombre a "${newName}"...`, 'info');
            try {
                const docRef = getFileDocRef(fileId);
                await updateDoc(docRef, {
                    name: newName.trim(),
                });
                showMessage("Nombre actualizado con éxito.", 'success');
            } catch (error) {
                console.error("Error al actualizar el nombre:", error);
                showMessage(`Error al editar: ${error.message}.`, 'error');
            }
        }

        window.downloadFile = function(r2Key) {
            const publicUrl = `${R2_PUBLIC_URL_BASE}/${r2Key}`;
            window.open(publicUrl, '_blank'); 
        }

        // --- Lógica de Subida Múltiple y Auth (Se mantienen) ---

        async function processSingleFile(file) {
            if (!userId) {
                throw new Error("La autenticación de usuario no está lista.");
            }

            if (file.size > MAX_FILE_SIZE_BYTES) {
                throw new Error(`El archivo "${file.name}" excede el límite de ${formatFileSize(MAX_FILE_SIZE_BYTES)}.`);
            }
            if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
                throw new Error(`El archivo "${file.name}" no es ni imagen ni video.`);
            }

            const fileNameWithoutExtension = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
            const uniqueKey = `${userId}/${crypto.randomUUID()}-${fileNameWithoutExtension}${fileExtension}`; 
            const objectKey = uniqueKey; 

            try {
                // PASO 1: SOLICITAR URL FIRMADA
                showMessage(`Paso 1/3: Solicitando URL firmada para subir "${file.name}"...`);

                const signedUrlResponse = await fetch(`${WORKER_ENDPOINT}?key=${objectKey}&contentType=${file.type}`);
                
                if (!signedUrlResponse.ok) {
                    const errorDetails = await signedUrlResponse.text();
                    throw new Error(`Error al obtener URL firmada. Estado: ${signedUrlResponse.status}. Detalle: ${errorDetails}`);
                }
                const { signedUrl } = await signedUrlResponse.json(); 
                if (!signedUrl) {
                    throw new Error("El Worker no devolvió una 'signedUrl' válida.");
                }


                // PASO 2: REALIZAR LA SUBIDA DEL ARCHIVO
                showMessage(`Paso 2/3: Subiendo "${file.name}" directamente a R2...`);

                const uploadResponse = await fetch(signedUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type,
                    }
                });

                if (!uploadResponse.ok) {
                    const errorBody = await uploadResponse.text();
                    throw new Error(`Fallo en la subida a R2. Estado: ${uploadResponse.status}. Respuesta de R2: ${errorBody}.`); 
                }

                // PASO 3: GUARDAR METADATOS EN FIRESTORE
                showMessage(`Paso 3/3: Guardando metadatos en Firestore...`);
                
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
                
                await addDoc(filesCollectionRef, {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    r2Key: objectKey, 
                    r2Bucket: R2_BUCKET_NAME,
                    uploaderId: userId,
                    uploadedAt: serverTimestamp(),
                });

                return { success: true, fileName: file.name };

            } catch (error) {
                return { success: false, fileName: file.name, error: error.message };
            }
        }

        async function uploadQueueProcessor(files) {
            if (isUploading) return;
            isUploading = true;

            uploadPrompt.classList.add('hidden');
            uploadIndicator.classList.remove('hidden');
            uploadButton.disabled = true;
            fileInput.disabled = true;

            let successCount = 0;
            let totalCount = files.length;
            
            showMessage(`Iniciando subida de ${totalCount} archivos...`);

            for (let i = 0; i < totalCount; i++) {
                const file = files[i];
                showMessage(`Subiendo ${file.name} (${i + 1} de ${totalCount})...`);
                
                const result = await processSingleFile(file);

                if (result.success) {
                    successCount++;
                } else {
                    console.error(`Fallo en la subida de ${result.fileName}:`, result.error);
                    showMessage(`Fallo al subir ${result.fileName}. Vea la consola.`, 'error');
                }
            }

            if (successCount === totalCount) {
                showMessage(`¡Subida masiva exitosa! ${successCount} archivos procesados.`, 'success');
            } else {
                showMessage(`Finalizado. ${successCount} de ${totalCount} archivos subidos con éxito.`, 'error');
            }


            isUploading = false;
            uploadIndicator.classList.add('hidden');
            uploadPrompt.classList.remove('hidden');
            uploadButton.disabled = false;
            fileInput.disabled = false;
            fileInput.value = ''; 
        }


        window.handleFiles = function (filesList) {
            if (!authReady) {
                showMessage("La aplicación se está inicializando. Por favor, espera.", 'info');
                return;
            }

            if (filesList && filesList.length > 0) {
                const filesArray = Array.from(filesList); 
                uploadQueueProcessor(filesArray);
            } else {
                showMessage('Por favor, selecciona al menos un archivo.', 'info');
            }
        }


        // --- Lógica de Autenticación y UI (Se mantiene) ---

        function updateUI(user) {
            if (user) {
                userId = user.uid;
                authStatus.textContent = `Sesión: ${user.email || user.displayName || user.uid}`;
                authControls.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                fileListSection.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                uploadButton.disabled = false;
                setupFirestoreListener(); 
            } else {
                userId = null;
                authStatus.textContent = "Por favor, inicia sesión.";
                authControls.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                fileListSection.classList.add('hidden');
                logoutButton.classList.add('hidden');
                uploadButton.disabled = true;
                fileList.innerHTML = ''; 
                emptyState.classList.remove('hidden');
            }
        }

        async function handleEmailSignUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                showMessage("Ingresa un email válido y una contraseña de 6+ caracteres.", 'error');
                return;
            }
            showMessage("Registrando usuario...");
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("¡Registro exitoso! Sesión iniciada.", 'success');
            } catch (error) {
                console.error("Error de registro:", error);
                showMessage(`Error de registro: ${error.message}`, 'error');
            }
        }

        async function handleEmailSignIn() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Ingresa email y contraseña.", 'error');
                return;
            }
            showMessage("Iniciando sesión...");
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Inicio de sesión exitoso.", 'success');
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                showMessage(`Error de inicio de sesión: ${error.message}`, 'error');
            }
        }

        async function handleGoogleSignIn() {
            showMessage("Abriendo Google Sign-In...");
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Inicio de sesión con Google exitoso.", 'success');
            } catch (error) {
                console.error("Error de Google Sign-In:", error);
                showMessage(`Error de Google Sign-In: ${error.message}`, 'error');
            }
        }

        async function handleSignOut() {
            showMessage("Cerrando sesión...");
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        }

        // Asignación de funciones al scope de la ventana (necesario para onclick en HTML)
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleEmailSignIn = handleEmailSignIn;
        window.handleEmailSignUp = handleEmailSignUp;
        window.handleSignOut = handleSignOut;
        window.showImageModal = showImageModal;
        window.hideImageModal = hideImageModal;


        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    authReady = true;
                    updateUI(user);
                    // LLAMADA CORREGIDA: Inicializa Drag and Drop solo después de que el DOM esté cargado
                    setupDragAndDrop(); 
                });
            } catch (e) {
                console.error("Error al inicializar la aplicación:", e);
                authStatus.textContent = 'Error al iniciar la app.';
                showMessage("Error al inicializar la aplicación. Consulta la consola.", 'error');
            }
        }

        function setupFirestoreListener() {
            if (!db || !userId) return;

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
            const q = query(filesCollectionRef);

            onSnapshot(q, (snapshot) => {
                let htmlContent = '';
                let fileCount = 0;

                const fetchedFiles = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    uploadedAt: doc.data().uploadedAt ? doc.data().uploadedAt.toDate() : new Date(0)
                }));

                fetchedFiles.sort((a, b) => b.uploadedAt - a.uploadedAt);

                fetchedFiles.forEach(file => {
                    // CORRECCIÓN: renderFileItem es accesible aquí
                    htmlContent += renderFileItem(file); 
                    fileCount++;
                });

                fileList.innerHTML = htmlContent;

                if (fileCount === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error al escuchar archivos:", error);
                showMessage("Error al cargar los archivos: " + error.message, 'error');
            });
        }

        // --- Lógica de Drag and Drop (CORREGIDA) ---
        function setupDragAndDrop() {
            const dropArea = document.getElementById('drop-area');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            function highlight() { dropArea.classList.add('drag-active'); }
            function unhighlight() { dropArea.classList.remove('drag-active'); }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                window.handleFiles(files);
            }
        }

        window.onload = initApp;

    </script>
</body>
</html>
