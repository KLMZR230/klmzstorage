<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLMZ Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        #drop-area.drag-active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #1f2937; /* bg-gray-800/70 */
        }
        /* Miniaturas */
        .thumbnail-container {
            width: 50px;
            height: 50px;
            overflow: hidden;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .thumbnail-container:hover {
            transform: scale(1.05);
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Botones de acción */
        .action-button {
            @apply p-1 rounded-full text-gray-400 hover:text-white transition duration-150 shadow-md;
        }
        .action-button.download { @apply hover:bg-indigo-600 hover:text-white; }
        .action-button.edit { @apply hover:bg-teal-600 hover:text-white; }
        .action-button.delete { @apply hover:bg-red-600 hover:text-white; }
        
        /* Fondos de Modal */
        #image-modal-backdrop, #edit-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.95);
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 sm:p-8">

        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-teal-400">
                    KLMZ Storage
                </h1>
                <p id="auth-status" class="text-gray-400 mt-1">Cargando sistema...</p>
            </div>
            <button id="logout-button" onclick="handleSignOut()" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition duration-150 hidden">
                Cerrar Sesión
            </button>
        </header>
        
        <div id="auth-controls" class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-md mx-auto mb-8 hidden">
            <h2 class="text-xl font-semibold text-white mb-4">Acceso Seguro</h2>
            
            <input type="email" id="email-input" placeholder="Correo Electrónico" class="w-full p-3 mb-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">

            <div class="flex space-x-3 mb-4">
                <button onclick="handleEmailSignIn()" class="flex-1 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    Entrar
                </button>
                <button onclick="handleEmailSignUp()" class="flex-1 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150">
                    Registrarse
                </button>
            </div>

            <div class="text-center my-4 text-gray-400">o continuar con</div>

            <button onclick="handleGoogleSignIn()" class="w-full py-2 bg-white text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/><path fill="#FF3D00" d="M24 44c6.333 0 11.667-2.083 15.55-5.633l-4.317-3.35c-2.375 1.583-5.3 2.516-8.233 2.516-6.425 0-11.883-4.317-13.842-10.15H5.85l-.167 3.433c3.784 7.467 11.4 12.75 18.317 12.75z"/><path fill="#4CAF50" d="M24 10.183c3.55 0 6.675 1.25 9.158 3.517l4.517-4.5c-4.1-3.783-9.583-6.133-13.675-6.133-6.917 0-14.534 5.283-18.317 12.75l4.192 3.267c1.958-5.834 7.416-10.15 13.842-10.15z"/><path fill="#1976D2" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/></svg>
                Google
            </button>
        </div>

        <div id="upload-section" class="mb-8 hidden"> 
            <div id="drop-area" class="relative p-8 rounded-xl border-4 border-gray-600 border-dashed bg-gray-800/50 transition-all duration-300">
                <input type="file" id="fileInput" class="hidden" accept="image/*,video/*" onchange="handleFiles(this.files)" multiple />
                <div class="flex flex-col items-center justify-center text-center">
                    <div id="upload-indicator" class="hidden flex items-center space-x-2 text-indigo-400">
                        <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-xl font-medium">Procesando archivos...</span>
                    </div>

                    <div id="upload-prompt" class="block">
                        <svg class="w-12 h-12 text-indigo-400 mb-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m0 0l3-3m-3 3l3 3" />
                        </svg>
                        <p class="text-gray-300 mb-4">Arrastra tus archivos aquí</p>
                        <button onclick="document.getElementById('fileInput').click()" id="upload-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50" disabled>
                            Seleccionar Archivos
                        </button>
                    </div>
                </div>
            </div>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-center text-sm font-medium bg-transparent text-white hidden"></div>
        </div>

        <section id="file-list-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-200 mb-4">Mis Archivos</h2>
            <div id="file-list" class="space-y-3">
                <p id="empty-state" class="text-gray-500 text-center py-10">Sube tu primer archivo para verlo aquí.</p>
            </div>
        </section>

    </div>
    
    <div id="edit-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center hidden" onclick="hideEditModal()">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
            <h3 class="text-xl font-semibold text-white mb-4">Editar Nombre</h3>
            <input type="text" id="new-file-name-input" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
            <div class="flex justify-end space-x-3">
                <button onclick="hideEditModal()" class="px-4 py-2 text-gray-400 rounded-lg hover:bg-gray-700">Cancelar</button>
                <button onclick="saveNewFileName()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Guardar</button>
            </div>
        </div>
    </div>

    <div id="image-modal-backdrop" class="fixed inset-0 z-50 flex items-center justify-center hidden" onclick="hideImageModal()">
        <div class="relative max-w-5xl max-h-screen p-4" onclick="event.stopPropagation()">
            <button onclick="hideImageModal()" class="absolute top-0 right-0 m-4 text-white text-3xl font-bold p-2 bg-black/50 rounded-full hover:bg-black/70">&times;</button>
            <img id="modal-image" src="" alt="Vista previa" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyClcgVHympGTuj7h4hgqxXfVcpqwWaKsyg",
            authDomain: "klmzstorage.firebaseapp.com",
            projectId: "klmzstorage", 
            storageBucket: "klmzstorage.firebasestorage.app",
            appId: "1:685345835162:web:be21ed8302df42360f3723"
        };
        const R2_BUCKET_NAME = 'klmzstorage';
        const WORKER_ENDPOINT = 'https://klmz-r2-signer-cli-production.klmzr.workers.dev/get-signed-url'; 
        const R2_PUBLIC_URL_BASE = 'https://pub-897465909ad64d05890fbf61be36d501.r2.dev'; 
        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

        // Variables Globales
        let app, db, auth, userId = null, isUploading = false, authReady = false;
        
        // Elementos DOM
        const els = {
            authStatus: document.getElementById('auth-status'),
            fileList: document.getElementById('file-list'),
            messageBox: document.getElementById('message-box'),
            uploadIndicator: document.getElementById('upload-indicator'),
            uploadPrompt: document.getElementById('upload-prompt'),
            uploadButton: document.getElementById('upload-button'),
            fileInput: document.getElementById('fileInput'),
            authControls: document.getElementById('auth-controls'),
            uploadSection: document.getElementById('upload-section'),
            fileListSection: document.getElementById('file-list-section'),
            logoutButton: document.getElementById('logout-button'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            emptyState: document.getElementById('empty-state'),
            modalBackdrop: document.getElementById('image-modal-backdrop'),
            modalImage: document.getElementById('modal-image'),
            editModalBackdrop: document.getElementById('edit-modal-backdrop'),
            newFileNameInput: document.getElementById('new-file-name-input')
        };

        // Estado para edición
        let editState = { fileId: null, currentName: null };

        // --- Funciones UI Globales ---
        window.showMessage = (msg, type = 'info') => {
            if (!msg) { els.messageBox.classList.add('hidden'); return; }
            els.messageBox.textContent = msg;
            els.messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium transition-colors';
            els.messageBox.classList.add(type === 'error' ? 'bg-red-900/50' : (type === 'success' ? 'bg-green-900/50' : 'bg-indigo-900/50'));
            els.messageBox.classList.add(type === 'error' ? 'text-red-300' : (type === 'success' ? 'text-green-300' : 'text-indigo-300'));
            els.messageBox.classList.remove('hidden');
            if (type !== 'error') setTimeout(() => els.messageBox.classList.add('hidden'), 5000);
        };

        // --- Funciones de Descarga y Modales (Globales) ---
        
        // DESCARGA MEJORADA: Cache Busting para evitar error CORS
        window.downloadFile = async (r2Key, fileName) => {
            const cacheBuster = "?t=" + new Date().getTime(); // Truco para evitar caché CORS vieja
            const publicUrl = `${R2_PUBLIC_URL_BASE}/${r2Key}${cacheBuster}`;
            
            window.showMessage(`Iniciando descarga de ${fileName}...`, 'info');

            try {
                const response = await fetch(publicUrl);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
                window.showMessage(`Descarga completada.`, 'success');
            } catch (error) {
                console.error("Error descarga:", error);
                // Fallback si falla fetch (abrir en pestaña)
                window.showMessage(`Error en descarga directa. Abriendo en pestaña nueva...`, 'error');
                setTimeout(() => window.open(`${R2_PUBLIC_URL_BASE}/${r2Key}`, '_blank'), 1500);
            }
        };

        window.showImageModal = (url) => { els.modalImage.src = url; els.modalBackdrop.classList.remove('hidden'); };
        window.hideImageModal = () => { els.modalBackdrop.classList.add('hidden'); els.modalImage.src = ''; };
        
        window.showEditModal = (id, name) => {
            editState = { fileId: id, currentName: name };
            els.newFileNameInput.value = name;
            els.editModalBackdrop.classList.remove('hidden');
        };
        window.hideEditModal = () => { els.editModalBackdrop.classList.add('hidden'); };

        window.saveNewFileName = async () => {
            const newName = els.newFileNameInput.value.trim();
            if (!newName || newName === editState.currentName) { window.hideEditModal(); return; }
            window.hideEditModal();
            window.showMessage("Actualizando...", 'info');
            try {
                const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'klmz_storage_files', editState.fileId);
                await updateDoc(docRef, { name: newName });
                window.showMessage("Nombre actualizado.", 'success');
            } catch (e) { window.showMessage(`Error al editar: ${e.message}`, 'error'); }
        };

        window.deleteFile = async (id, name) => {
            if (!confirm(`¿Borrar "${name}" de la lista? (El archivo en R2 permanecerá hasta borrado manual)`)) return;
            try {
                const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'klmz_storage_files', id);
                await deleteDoc(docRef);
                window.showMessage("Archivo eliminado de la lista.", 'success');
            } catch (e) { window.showMessage(`Error al borrar: ${e.message}`, 'error'); }
        };

        // --- Renderizado ---
        function renderFileItem(file) {
            const date = file.uploadedAt?.toDate ? file.uploadedAt.toDate().toLocaleString() : new Date().toLocaleString();
            const url = `${R2_PUBLIC_URL_BASE}/${file.r2Key}`;
            const icon = file.type.startsWith('image/') 
                ? `<div class="thumbnail-container bg-gray-700" onclick="showImageModal('${url}')"><img src="${url}" loading="lazy"></div>`
                : `<div class="p-2 bg-gray-700 rounded"><svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></div>`;

            return `
                <div class="flex items-center justify-between p-4 bg-gray-800 rounded-xl shadow-md hover:bg-gray-750 transition-colors">
                    <div class="flex items-center space-x-4 min-w-0">
                        ${icon}
                        <div class="min-w-0">
                            <p class="text-sm font-semibold truncate text-white">${file.name}</p>
                            <p class="text-xs text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <p class="text-xs text-gray-500 hidden sm:block mr-2">${date}</p>
                        <button onclick="downloadFile('${file.r2Key}', '${file.name}')" class="action-button download" title="Descargar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                        <button onclick="showEditModal('${file.id}', '${file.name}')" class="action-button edit" title="Editar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4l-4 4"></path></svg></button>
                        <button onclick="deleteFile('${file.id}', '${file.name}')" class="action-button delete" title="Borrar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </div>`;
        }

        // --- Core: Carga y Subida ---
        async function processFile(file) {
            if (file.size > MAX_FILE_SIZE) throw new Error(`${file.name} es muy grande (>100MB).`);
            
            // 1. Obtener URL firmada
            const key = `${userId}/${crypto.randomUUID()}.${file.name.split('.').pop()}`;
            const res = await fetch(`${WORKER_ENDPOINT}?key=${key}&contentType=${file.type}`);
            if (!res.ok) throw new Error("Error obteniendo firma.");
            const { signedUrl } = await res.json();

            // 2. Subir a R2
            const upload = await fetch(signedUrl, { method: 'PUT', body: file, headers: { 'Content-Type': file.type } });
            if (!upload.ok) throw new Error("Error subiendo a R2.");

            // 3. Guardar en Firestore
            await addDoc(collection(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId), 'klmz_storage_files'), {
                name: file.name, type: file.type, size: file.size, r2Key: key, r2Bucket: R2_BUCKET_NAME, uploaderId: userId, uploadedAt: serverTimestamp()
            });
            return true;
        }

        async function processQueue(files) {
            if (isUploading) return;
            isUploading = true;
            els.uploadPrompt.classList.add('hidden');
            els.uploadIndicator.classList.remove('hidden');
            els.uploadButton.disabled = true;

            let count = 0;
            for (const file of files) {
                window.showMessage(`Subiendo ${file.name}...`);
                try { await processFile(file); count++; } 
                catch (e) { console.error(e); window.showMessage(`Fallo en ${file.name}`, 'error'); }
            }
            window.showMessage(`Completado: ${count}/${files.length} subidos.`, count === files.length ? 'success' : 'info');
            
            isUploading = false;
            els.uploadIndicator.classList.add('hidden');
            els.uploadPrompt.classList.remove('hidden');
            els.uploadButton.disabled = false;
            els.fileInput.value = '';
        }

        window.handleFiles = (list) => {
            if (!authReady || !userId) return window.showMessage("Espera a que cargue la sesión.", 'error');
            if (list?.length) processQueue(Array.from(list));
        };

        // --- Auth & Init ---
        function updateUI(user) {
            if (user) {
                userId = user.uid;
                els.authStatus.textContent = `Hola, ${user.email}`;
                els.authControls.classList.add('hidden');
                els.uploadSection.classList.remove('hidden');
                els.fileListSection.classList.remove('hidden');
                els.logoutButton.classList.remove('hidden');
                els.uploadButton.disabled = false;
                
                // Listener de Firestore
                const q = query(collection(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId), 'klmz_storage_files'));
                onSnapshot(q, (snap) => {
                    const files = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.uploadedAt - a.uploadedAt);
                    els.fileList.innerHTML = files.map(renderFileItem).join('');
                    els.emptyState.classList.toggle('hidden', files.length > 0);
                });
            } else {
                userId = null;
                els.authStatus.textContent = "Acceso Requerido";
                els.authControls.classList.remove('hidden');
                els.uploadSection.classList.add('hidden');
                els.fileListSection.classList.add('hidden');
                els.logoutButton.classList.add('hidden');
            }
        }

        window.handleEmailSignIn = async () => {
            try { await signInWithEmailAndPassword(auth, els.emailInput.value, els.passwordInput.value); }
            catch(e) { window.showMessage("Error: " + e.message, 'error'); }
        };
        window.handleEmailSignUp = async () => {
            try { await createUserWithEmailAndPassword(auth, els.emailInput.value, els.passwordInput.value); }
            catch(e) { window.showMessage("Error: " + e.message, 'error'); }
        };
        window.handleGoogleSignIn = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch(e) { window.showMessage("Error Google: " + e.message, 'error'); }
        };
        window.handleSignOut = () => signOut(auth);

        // Inicialización y Drag & Drop
        window.onload = () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (u) => { authReady = true; updateUI(u); });

                const dropArea = document.getElementById('drop-area');
                ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, (ev) => { ev.preventDefault(); dropArea.classList.add('drag-active'); }));
                ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, (ev) => { ev.preventDefault(); dropArea.classList.remove('drag-active'); }));
                dropArea.addEventListener('drop', (e) => window.handleFiles(e.dataTransfer.files));
            } catch (e) { console.error(e); }
        };
    </script>
</body>
</html>
