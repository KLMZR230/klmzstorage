<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLMZ Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración de fuente Inter y fondo oscuro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        /* Estilo para el área de drop para que cubra la zona */
        #drop-area.drag-active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #1f2937; /* bg-gray-800/70 */
        }
        /* Estilo para que la miniatura cubra el contenedor */
        .thumbnail-container {
            width: 50px; /* Tamaño fijo para la miniatura */
            height: 50px;
            overflow: hidden;
            border-radius: 6px;
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que la imagen cubra el área sin distorsión */
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 sm:p-8">

        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-teal-400">
                    KLMZ Storage
                </h1>
                <p id="auth-status" class="text-gray-400 mt-1">Esperando autenticación...</p>
            </div>
            <button id="logout-button" onclick="handleSignOut()" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition duration-150 hidden">
                Cerrar Sesión
            </button>
        </header>
        
        <div id="auth-controls" class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-md mx-auto mb-8 hidden">
            <h2 class="text-xl font-semibold text-white mb-4">Iniciar Sesión / Registrarse</h2>
            
            <input type="email" id="email-input" placeholder="Correo Electrónico" class="w-full p-3 mb-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">

            <div class="flex space-x-3 mb-4">
                <button onclick="handleEmailSignIn()" class="flex-1 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    Iniciar Sesión
                </button>
                <button onclick="handleEmailSignUp()" class="flex-1 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150">
                    Registrarse
                </button>
            </div>

            <div class="text-center my-4 text-gray-400">o continuar con</div>

            <button onclick="handleGoogleSignIn()" class="w-full py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/><path fill="#FF3D00" d="M24 44c6.333 0 11.667-2.083 15.55-5.633l-4.317-3.35c-2.375 1.583-5.3 2.516-8.233 2.516-6.425 0-11.883-4.317-13.842-10.15H5.85l-.167 3.433c3.784 7.467 11.4 12.75 18.317 12.75z"/><path fill="#4CAF50" d="M24 10.183c3.55 0 6.675 1.25 9.158 3.517l4.517-4.5c-4.1-3.783-9.583-6.133-13.675-6.133-6.917 0-14.534 5.283-18.317 12.75l4.192 3.267c1.958-5.834 7.416-10.15 13.842-10.15z"/><path fill="#1976D2" d="M43.61 20.083c0-.995-.083-1.933-.246-2.833H24v5.333h10.975c-.475 2.117-1.633 3.917-3.275 5.25v.083l4.317 3.35c2.567-2.367 4.05-5.833 4.05-9.683z"/></svg>
                Google
            </button>
        </div>
        <div id="upload-section" class="mb-8 hidden"> 
            <div id="drop-area" class="relative p-8 rounded-xl border-4 border-gray-600 border-dashed bg-gray-800/50 transition-all duration-300">
                <input
                    type="file"
                    id="fileInput"
                    class="hidden"
                    accept="image/*,video/*"
                    onchange="handleFiles(this.files)"
                />
                <div class="flex flex-col items-center justify-center text-center">
                    <div id="upload-indicator" class="hidden flex items-center space-x-2 text-indigo-400">
                        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-lg font-medium">Subiendo...</span>
                    </div>

                    <div id="upload-prompt" class="block">
                        <svg class="w-12 h-12 text-indigo-400 mb-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4H9m0 0l3-3m-3 3l3 3" />
                        </svg>
                        <p class="text-gray-300 mb-4">Arrastra y suelta tu video o foto aquí, o haz clic.</p>
                        <button
                            onclick="document.getElementById('fileInput').click()"
                            id="upload-button"
                            class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50"
                            disabled
                        >
                            Seleccionar Archivo
                        </button>
                    </div>
                </div>
            </div>

            <div id="message-box" class="mt-4 p-3 rounded-lg text-center text-sm font-medium bg-transparent text-white hidden"></div>
        </div>

        <section id="file-list-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-200 mb-4">Mis Archivos</h2>
            <div id="file-list" class="space-y-3">
                <p id="empty-state" class="text-gray-500 text-center py-10">
                    Sube tu primer archivo para verlo aquí.
                </p>
                </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables Globales
        let app;
        let db;
        let auth;
        let userId = null;
        let isUploading = false;
        let authReady = false; 

        // ----------------------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE (Credenciales verificadas)
        const firebaseConfig = {
            apiKey: "AIzaSyClcgVHympGTuj7h4hgqxXfVcpqwWaKsyg",
            authDomain: "klmzstorage.firebaseapp.com",
            projectId: "klmzstorage", 
            storageBucket: "klmzstorage.firebasestorage.app",
            messagingSenderId: "685345835162",
            appId: "1:685345835162:web:be21ed8302df42360f3723"
        };
        // ----------------------------------------------------------------------------------

        // --- CONFIGURACIÓN DE R2 ---
        const R2_BUCKET_NAME = 'klmzstorage';
        const WORKER_ENDPOINT = 'https://klmz-r2-signer-cli-production.klmzr.workers.dev/get-signed-url'; 
        const R2_PUBLIC_URL_BASE = 'https://pub-897465909ad64d05890fbf61be36d501.r2.dev'; 

        const appId = firebaseConfig.projectId;
        const MAX_FILE_SIZE_BYTES = 100 * 1024 * 1024; // Límite de 100MB

        // Elementos del DOM
        const authStatus = document.getElementById('auth-status');
        const fileList = document.getElementById('file-list');
        const emptyState = document.getElementById('empty-state');
        const messageBox = document.getElementById('message-box');
        const uploadIndicator = document.getElementById('upload-indicator');
        const uploadPrompt = document.getElementById('upload-prompt');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('fileInput');
        const authControls = document.getElementById('auth-controls');
        const uploadSection = document.getElementById('upload-section');
        const fileListSection = document.getElementById('file-list-section');
        const logoutButton = document.getElementById('logout-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');


        // --- Utilidades ---
        function showMessage(msg, type = 'info') {
            if (!msg) {
                messageBox.classList.add('hidden');
                return;
            }

            messageBox.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'text-red-300', 'text-green-300', 'text-white', 'bg-indigo-900/50', 'text-indigo-300');

            if (type === 'error') {
                messageBox.classList.add('bg-red-900/50', 'text-red-300');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-900/50', 'text-green-300');
            } else {
                messageBox.classList.add('bg-indigo-900/50', 'text-indigo-300');
            }

            if (type !== 'error') {
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- FUNCIÓN MEJORADA: Incluye miniatura o icono
        function getFileDisplay(type, publicUrl) {
            if (type.startsWith('image/')) {
                // Muestra la miniatura para imágenes
                return `<div class="thumbnail-container bg-gray-600">
                            <img src="${publicUrl}" alt="Miniatura" loading="lazy">
                        </div>`;
            } else if (type.startsWith('video/')) {
                return `<svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.7V15.3a1 1 0 01-1.447.886L15 14M4 14V9a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2z" />
                </svg>`;
            } else {
                return `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>`;
            }
        }

        // --- FUNCIÓN MEJORADA: Renderiza el elemento de la lista
        function renderFileItem(file) {
            const date = new Date(file.uploadedAt);
            const publicUrl = `${R2_PUBLIC_URL_BASE}/${file.r2Key}`; 
            const displayIcon = getFileDisplay(file.type, publicUrl);

            return `
                <div class="flex items-center justify-between p-4 bg-gray-800 rounded-xl shadow-md transition-colors duration-200 hover:bg-gray-700">
                    <div class="flex items-center space-x-4 min-w-0">
                        ${displayIcon}
                        <div class="min-w-0">
                            <p class="text-sm font-semibold truncate text-white">${file.name}</p>
                            <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <div class="text-right ml-4 flex-shrink-0 flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4">
                        <p class="text-xs text-gray-500">${date.toLocaleString()}</p>
                        <a href="${publicUrl}" target="_blank" class="px-3 py-1 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition duration-150">
                            Ver/Descargar
                        </a>
                    </div>
                </div>
            `;
        }


        // --- Lógica de Subida a R2 y Firestore ---
        async function uploadToR2(file) {
            if (!authReady || !userId) {
                showMessage("La aplicación no está lista o la autenticación falló. Por favor, espera unos segundos e inténtalo de nuevo.", 'error');
                console.error("Fallo de subida: authReady:", authReady, "userId:", userId);
                return;
            }

            if (isUploading) {
                showMessage("Ya hay una subida en curso.", 'error');
                return;
            }
            
            if (file.size > MAX_FILE_SIZE_BYTES) {
                showMessage(`El archivo "${file.name}" excede el límite de ${formatFileSize(MAX_FILE_SIZE_BYTES)}.`, 'error');
                return;
            }

            isUploading = true;
            uploadPrompt.classList.add('hidden');
            uploadIndicator.classList.remove('hidden');
            uploadButton.disabled = true;
            fileInput.disabled = true;

            const fileNameWithoutExtension = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
            const uniqueKey = `${userId}/${crypto.randomUUID()}-${fileNameWithoutExtension}${fileExtension}`; 
            const objectKey = uniqueKey; 


            try {
                // PASO 1/3: SOLICITAR URL FIRMADA AL WORKER (Backend)
                showMessage(`Paso 1/3: Solicitando URL firmada para subir "${file.name}"...`);

                const signedUrlResponse = await fetch(`${WORKER_ENDPOINT}?key=${objectKey}&contentType=${file.type}`);
                
                if (!signedUrlResponse.ok) {
                    const errorDetails = await signedUrlResponse.text();
                    throw new Error(`Error al obtener URL firmada. Estado: ${signedUrlResponse.status}. Detalle: ${errorDetails}`);
                }
                
                const { signedUrl } = await signedUrlResponse.json(); 
                
                if (!signedUrl) {
                    throw new Error("El Worker no devolvió una 'signedUrl' válida.");
                }


                // PASO 2/3: REALIZAR LA SUBIDA DEL ARCHIVO DIRECTAMENTE A R2 USANDO LA URL FIRMADA
                showMessage(`Paso 2/3: Subiendo "${file.name}" directamente a R2...`);
                
                const uploadResponse = await fetch(signedUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type,
                    }
                });

                if (!uploadResponse.ok) {
                    const errorBody = await uploadResponse.text();
                    throw new Error(`Fallo en la subida a R2. Estado: ${uploadResponse.status}. Respuesta de R2: ${errorBody}.`); 
                }

                // PASO 3/3: GUARDAR METADATOS EN FIRESTORE
                showMessage(`Paso 3/3: Guardando metadatos en Firestore...`);
                
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
                
                await addDoc(filesCollectionRef, {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    r2Key: objectKey, 
                    r2Bucket: R2_BUCKET_NAME,
                    uploaderId: userId,
                    uploadedAt: serverTimestamp(),
                });
                showMessage(`¡"${file.name}" subido a R2 y metadatos guardados con éxito!`, 'success');

            } catch (error) {
                console.error("Error crítico durante la subida:", error);
                showMessage(`Error de Subida: ${error.message}`, 'error');
            } finally {
                isUploading = false;
                uploadIndicator.classList.add('hidden');
                uploadPrompt.classList.remove('hidden');
                uploadButton.disabled = false;
                fileInput.disabled = false;
                fileInput.value = ''; 
            }
        }

        window.handleFiles = function (filesList) {
            if (!authReady) {
                showMessage("La aplicación se está inicializando. Por favor, espera y vuelve a seleccionar el archivo.", 'info');
                return;
            }

            if (isUploading) return;

            if (!filesList || filesList.length === 0) {
                showMessage('Por favor, selecciona un archivo.');
                return;
            }

            const file = filesList[0];
            if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
                showMessage('Solo se permiten archivos de video e imagen (fotos).', 'error');
                return;
            }

            uploadToR2(file);
        }

        // --- Lógica de Autenticación y UI ---

        function updateUI(user) {
            if (user) {
                // Usuario logueado
                userId = user.uid;
                authStatus.textContent = `Sesión: ${user.email || user.displayName || user.uid}`;
                authControls.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                fileListSection.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                uploadButton.disabled = false;
                setupFirestoreListener(); // Inicia el listener de datos
            } else {
                // Usuario deslogueado
                userId = null;
                authStatus.textContent = "Por favor, inicia sesión.";
                authControls.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                fileListSection.classList.add('hidden');
                logoutButton.classList.add('hidden');
                uploadButton.disabled = true;
                fileList.innerHTML = ''; // Limpia la lista de archivos
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        async function handleEmailSignUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                showMessage("Ingresa un email válido y una contraseña de 6+ caracteres.", 'error');
                return;
            }
            showMessage("Registrando usuario...");
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("¡Registro exitoso! Sesión iniciada.", 'success');
            } catch (error) {
                console.error("Error de registro:", error);
                showMessage(`Error de registro: ${error.message}`, 'error');
            }
        }

        async function handleEmailSignIn() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showMessage("Ingresa email y contraseña.", 'error');
                return;
            }
            showMessage("Iniciando sesión...");
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Inicio de sesión exitoso.", 'success');
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                showMessage(`Error de inicio de sesión: ${error.message}`, 'error');
            }
        }

        async function handleGoogleSignIn() {
            showMessage("Abriendo Google Sign-In...");
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Inicio de sesión con Google exitoso.", 'success');
            } catch (error) {
                console.error("Error de Google Sign-In:", error);
                showMessage(`Error de Google Sign-In: ${error.message}`, 'error');
            }
        }

        async function handleSignOut() {
            showMessage("Cerrando sesión...");
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        }
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleEmailSignIn = handleEmailSignIn;
        window.handleEmailSignUp = handleEmailSignUp;
        window.handleSignOut = handleSignOut;


        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Listener principal de autenticación
                onAuthStateChanged(auth, (user) => {
                    authReady = true;
                    updateUI(user);
                });
            } catch (e) {
                console.error("Error al inicializar la aplicación:", e);
                authStatus.textContent = 'Error al iniciar la app.';
                showMessage("Error al inicializar la aplicación. Consulta la consola.", 'error');
            }
        }

        function setupFirestoreListener() {
            if (!db || !userId) return;

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
            const q = query(filesCollectionRef);

            onSnapshot(q, (snapshot) => {
                let htmlContent = '';
                let fileCount = 0;

                const fetchedFiles = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    uploadedAt: doc.data().uploadedAt ? doc.data().uploadedAt.toDate() : new Date(0)
                }));

                fetchedFiles.sort((a, b) => b.uploadedAt - a.uploadedAt);

                fetchedFiles.forEach(file => {
                    const displayFile = { ...file, uploadedAt: file.uploadedAt.toLocaleString() };
                    htmlContent += renderFileItem(displayFile);
                    fileCount++;
                });

                fileList.innerHTML = htmlContent;

                if (fileCount === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                }
            }, (error) => {
                console.error("Error al escuchar archivos:", error);
                showMessage("Error al cargar los archivos: " + error.message, 'error');
            });
        }

        // --- Lógica de Drag and Drop ---
        const dropArea = document.getElementById('drop-area');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        function highlight() { dropArea.classList.add('drag-active'); }
        function unhighlight() { dropArea.classList.remove('drag-active'); }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            window.handleFiles(files);
        }

        window.onload = initApp;

    </script>
</body>
</html>
