<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithPopup, 
        GoogleAuthProvider, 
        onAuthStateChanged, 
        signOut,
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables Globales
    let app;
    let db;
    let auth;
    let userId = null;
    let isUploading = false;
    let authReady = false; 

    // ----------------------------------------------------------------------------------
    // CONFIGURACIÓN DE FIREBASE (Credenciales verificadas)
    const firebaseConfig = {
        apiKey: "AIzaSyClcgVHympGTuj7h4hgqxXfVcpqwWaKsyg",
        authDomain: "klmzstorage.firebaseapp.com",
        projectId: "klmzstorage", 
        storageBucket: "klmzstorage.firebasestorage.app",
        appId: "1:685345835162:web:be21ed8302df42360f3723"
    };
    // ----------------------------------------------------------------------------------

    // --- CONFIGURACIÓN DE R2 ---
    const R2_BUCKET_NAME = 'klmzstorage';
    const WORKER_ENDPOINT = 'https://klmz-r2-signer-cli-production.klmzr.workers.dev/get-signed-url'; 
    const R2_PUBLIC_URL_BASE = 'https://pub-897465909ad64d05890fbf61be36d501.r2.dev'; 

    const appId = firebaseConfig.projectId;
    const MAX_FILE_SIZE_BYTES = 100 * 1024 * 1024; 

    // Elementos del DOM (cacheados para evitar TypeError: Cannot read properties of null)
    const authStatus = document.getElementById('auth-status');
    const fileList = document.getElementById('file-list');
    const messageBox = document.getElementById('message-box');
    const uploadIndicator = document.getElementById('upload-indicator');
    const uploadPrompt = document.getElementById('upload-prompt');
    const uploadButton = document.getElementById('upload-button');
    const fileInput = document.getElementById('fileInput');
    const authControls = document.getElementById('auth-controls');
    const uploadSection = document.getElementById('upload-section');
    const fileListSection = document.getElementById('file-list-section');
    const logoutButton = document.getElementById('logout-button');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const emptyState = document.getElementById('empty-state'); // Referencia al empty state

    // --- Utilidades ---
    function showMessage(msg, type = 'info') {
        if (!msg) {
            messageBox.classList.add('hidden');
            return;
        }
        messageBox.textContent = msg;
        messageBox.className = 'mt-4 p-3 rounded-lg text-center text-sm font-medium transition-colors';

        if (type === 'error') {
            messageBox.classList.add('bg-red-900/50', 'text-red-300');
        } else if (type === 'success') {
            messageBox.classList.add('bg-green-900/50', 'text-green-300');
        } else {
            messageBox.classList.add('bg-indigo-900/50', 'text-indigo-300');
        }
        messageBox.classList.remove('hidden');

        if (type !== 'error') {
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileDisplay(type, publicUrl) {
        if (type.startsWith('image/')) {
            return `<div class="thumbnail-container bg-gray-600">
                        <img src="${publicUrl}" alt="Miniatura" loading="lazy">
                    </div>`;
        } else {
            return `<div class="p-1 rounded bg-gray-600/50">${type.startsWith('video/') ? 
                `<svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.7V15.3a1 1 0 01-1.447.886L15 14M4 14V9a2 2 0 012-2h10a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2z" /></svg>` : 
                `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`}</div>`;
        }
    }

    // CORRECCIÓN PRINCIPAL: Mover esta función al scope global (o dentro de window)
    // o asegurar que sea accesible por setupFirestoreListener
    // La dejaremos dentro de setupFirestoreListener para mantenerla aislada, 
    // pero replicaremos el error en el loop de fetch.
    function renderFileItem(file) {
        const date = new Date(file.uploadedAt);
        const publicUrl = `${R2_PUBLIC_URL_BASE}/${file.r2Key}`; 
        const displayIcon = getFileDisplay(file.type, publicUrl);

        return `
            <div class="flex items-center justify-between p-4 bg-gray-800 rounded-xl shadow-md transition-colors duration-200 hover:bg-gray-700">
                <div class="flex items-center space-x-4 min-w-0">
                    ${displayIcon}
                    <div class="min-w-0">
                        <p class="text-sm font-semibold truncate text-white">${file.name}</p>
                        <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <div class="text-right ml-4 flex-shrink-0 flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-3">
                    
                    <p class="text-xs text-gray-500 hidden sm:block">${date.toLocaleString()}</p>

                    <button onclick="downloadFile('${file.r2Key}')" class="action-button">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    
                    <button onclick="editFileName('${file.id}', '${file.name}')" class="action-button">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4l-4 4"></path></svg>
                    </button>
                    
                    <button onclick="deleteFile('${file.id}', '${file.name}', '${file.r2Key}')" class="action-button text-red-400 hover:text-red-300">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
        `;
    }

    // --- Funciones CRUD y Descarga (Asignadas al scope global) ---

    // Función auxiliar para obtener la referencia del documento
    function getFileDocRef(fileId) {
        const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
        const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
        return doc(filesCollectionRef, fileId);
    }

    window.deleteFile = async function(fileId, fileName, r2Key) {
        if (!confirm(`¿Estás seguro de que quieres eliminar "${fileName}"? Esta acción es permanente y eliminará el registro de la lista.`)) {
            return;
        }
        
        showMessage(`Eliminando "${fileName}" de la base de datos...`, 'info');

        try {
            const docRef = getFileDocRef(fileId);
            await deleteDoc(docRef);

            showMessage(`"${fileName}" eliminado con éxito.`, 'success');

        } catch (error) {
            console.error("Error al eliminar el archivo:", error);
            showMessage(`Error al eliminar: ${error.message}. (Verifique las Reglas de Seguridad).`, 'error');
        }
    }

    window.editFileName = async function(fileId, currentName) {
        const newName = prompt(`Introduce el nuevo nombre para "${currentName}":`, currentName);
        if (!newName || newName.trim() === currentName) {
            return;
        }

        showMessage(`Actualizando nombre a "${newName}"...`, 'info');
        try {
            const docRef = getFileDocRef(fileId);
            await updateDoc(docRef, {
                name: newName.trim(),
            });
            showMessage("Nombre actualizado con éxito.", 'success');
        } catch (error) {
            console.error("Error al actualizar el nombre:", error);
            showMessage(`Error al editar: ${error.message}.`, 'error');
        }
    }

    window.downloadFile = function(r2Key) {
        const publicUrl = `${R2_PUBLIC_URL_BASE}/${r2Key}`;
        window.open(publicUrl, '_blank'); 
    }


    // --- PROCESAMIENTO DE ARCHIVO ÚNICO (Llamado por la cola) ---
    async function processSingleFile(file) {
        if (!userId) {
            throw new Error("La autenticación de usuario no está lista.");
        }

        if (file.size > MAX_FILE_SIZE_BYTES) {
            throw new Error(`El archivo "${file.name}" excede el límite de ${formatFileSize(MAX_FILE_SIZE_BYTES)}.`);
        }
        if (!file.type.startsWith('video/') && !file.type.startsWith('image/')) {
            throw new Error(`El archivo "${file.name}" no es ni imagen ni video.`);
        }

        const fileNameWithoutExtension = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
        const fileExtension = file.name.substring(file.name.lastIndexOf('.'));
        const uniqueKey = `${userId}/${crypto.randomUUID()}-${fileNameWithoutExtension}${fileExtension}`; 
        const objectKey = uniqueKey; 

        try {
            // PASO 1: SOLICITAR URL FIRMADA
            const signedUrlResponse = await fetch(`${WORKER_ENDPOINT}?key=${objectKey}&contentType=${file.type}`);
            
            if (!signedUrlResponse.ok) {
                const errorDetails = await signedUrlResponse.text();
                throw new Error(`Error al obtener URL firmada. Estado: ${signedUrlResponse.status}. Detalle: ${errorDetails}`);
            }
            const { signedUrl } = await signedUrlResponse.json(); 
            if (!signedUrl) {
                throw new Error("El Worker no devolvió una 'signedUrl' válida.");
            }


            // PASO 2: REALIZAR LA SUBIDA DEL ARCHIVO
            const uploadResponse = await fetch(signedUrl, {
                method: 'PUT',
                body: file,
                headers: {
                    'Content-Type': file.type,
                }
            });

            if (!uploadResponse.ok) {
                const errorBody = await uploadResponse.text();
                throw new Error(`Fallo en la subida a R2. Estado: ${uploadResponse.status}. Respuesta de R2: ${errorBody}.`); 
            }

            // PASO 3: GUARDAR METADATOS EN FIRESTORE
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
            
            await addDoc(filesCollectionRef, {
                name: file.name,
                type: file.type,
                size: file.size,
                r2Key: objectKey, 
                r2Bucket: R2_BUCKET_NAME,
                uploaderId: userId,
                uploadedAt: serverTimestamp(),
            });

            return { success: true, fileName: file.name };

        } catch (error) {
            return { success: false, fileName: file.name, error: error.message };
        }
    }

    // --- FUNCIÓN PRINCIPAL DE COLA DE SUBIDA (Permite múltiples archivos) ---
    async function uploadQueueProcessor(files) {
        if (isUploading) return;
        isUploading = true;

        uploadPrompt.classList.add('hidden');
        uploadIndicator.classList.remove('hidden');
        uploadButton.disabled = true;
        fileInput.disabled = true;

        let successCount = 0;
        let totalCount = files.length;
        
        showMessage(`Iniciando subida de ${totalCount} archivos...`);

        for (let i = 0; i < totalCount; i++) {
            const file = files[i];
            showMessage(`Subiendo ${file.name} (${i + 1} de ${totalCount})...`);
            
            const result = await processSingleFile(file);

            if (result.success) {
                successCount++;
            } else {
                console.error(`Fallo en la subida de ${result.fileName}:`, result.error);
                showMessage(`Fallo al subir ${result.fileName}. Vea la consola.`, 'error');
            }
        }

        if (successCount === totalCount) {
            showMessage(`¡Subida masiva exitosa! ${successCount} archivos procesados.`, 'success');
        } else {
            showMessage(`Finalizado. ${successCount} de ${totalCount} archivos subidos con éxito.`, 'error');
        }


        isUploading = false;
        uploadIndicator.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        uploadButton.disabled = false;
        fileInput.disabled = false;
        fileInput.value = ''; 
    }


    window.handleFiles = function (filesList) {
        if (!authReady) {
            showMessage("La aplicación se está inicializando. Por favor, espera.", 'info');
            return;
        }

        if (filesList && filesList.length > 0) {
            const filesArray = Array.from(filesList); 
            uploadQueueProcessor(filesArray);
        } else {
            showMessage('Por favor, selecciona al menos un archivo.', 'info');
        }
    }


    // --- Lógica de Autenticación y UI ---

    function updateUI(user) {
        if (user) {
            userId = user.uid;
            authStatus.textContent = `Sesión: ${user.email || user.displayName || user.uid}`;
            authControls.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            fileListSection.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
            uploadButton.disabled = false;
            setupFirestoreListener(); 
        } else {
            userId = null;
            authStatus.textContent = "Por favor, inicia sesión.";
            authControls.classList.remove('hidden');
            uploadSection.classList.add('hidden');
            fileListSection.classList.add('hidden');
            logoutButton.classList.add('hidden');
            uploadButton.disabled = true;
            fileList.innerHTML = ''; 
            document.getElementById('empty-state').classList.remove('hidden');
        }
    }

    async function handleEmailSignUp() {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || password.length < 6) {
            showMessage("Ingresa un email válido y una contraseña de 6+ caracteres.", 'error');
            return;
        }
        showMessage("Registrando usuario...");
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage("¡Registro exitoso! Sesión iniciada.", 'success');
        } catch (error) {
            console.error("Error de registro:", error);
            showMessage(`Error de registro: ${error.message}`, 'error');
        }
    }

    async function handleEmailSignIn() {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
            showMessage("Ingresa email y contraseña.", 'error');
            return;
        }
        showMessage("Iniciando sesión...");
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage("Inicio de sesión exitoso.", 'success');
        } catch (error) {
            console.error("Error de inicio de sesión:", error);
            showMessage(`Error de inicio de sesión: ${error.message}`, 'error');
        }
    }

    async function handleGoogleSignIn() {
        showMessage("Abriendo Google Sign-In...");
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            showMessage("Inicio de sesión con Google exitoso.", 'success');
        } catch (error) {
            console.error("Error de Google Sign-In:", error);
            showMessage(`Error de Google Sign-In: ${error.message}`, 'error');
        }
    }

    async function handleSignOut() {
        showMessage("Cerrando sesión...");
        try {
            await signOut(auth);
            showMessage("Sesión cerrada.", 'info');
        } catch (error) {
            console.error("Error al cerrar sesión:", error);
            showMessage(`Error al cerrar sesión: ${error.message}`, 'error');
        }
    }

    window.handleGoogleSignIn = handleGoogleSignIn;
    window.handleEmailSignIn = handleEmailSignIn;
    window.handleEmailSignUp = handleEmailSignUp;
    window.handleSignOut = handleSignOut;

    async function initApp() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                authReady = true;
                updateUI(user);
            });
        } catch (e) {
            console.error("Error al inicializar la aplicación:", e);
            authStatus.textContent = 'Error al iniciar la app.';
            showMessage("Error al inicializar la aplicación. Consulta la consola.", 'error');
        }
    }

    function setupFirestoreListener() {
        if (!db || !userId) return;

        const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
        const filesCollectionRef = collection(userDocRef, 'klmz_storage_files');
        const q = query(filesCollectionRef);

        onSnapshot(q, (snapshot) => {
            let htmlContent = '';
            let fileCount = 0;

            const fetchedFiles = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                uploadedAt: doc.data().uploadedAt ? doc.data().uploadedAt.toDate() : new Date(0)
            }));

            fetchedFiles.sort((a, b) => b.uploadedAt - a.uploadedAt);

            fetchedFiles.forEach(file => {
                htmlContent += renderFileItem(file);
                fileCount++;
            });

            fileList.innerHTML = htmlContent;

            if (fileCount === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }
        }, (error) => {
            console.error("Error al escuchar archivos:", error);
            showMessage("Error al cargar los archivos: " + error.message, 'error');
        });
    }

    // --- Lógica de Drag and Drop ---
    const dropArea = document.getElementById('drop-area');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    function highlight() { dropArea.classList.add('drag-active'); }
    function unhighlight() { dropArea.classList.remove('drag-active'); }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        window.handleFiles(files);
    }

    window.onload = initApp;

</script>
</body>
</html>
